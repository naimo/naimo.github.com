---
layout: post
title: Time synchronization between android devices
image: timesync
---
<div class="well">
	<p>
		As part of a larger android project, I need to be able to synchronize the clocks between android devices connected to the same wifi network, with an accuracy of a few milliseconds.
	</p>
</div>

<div class="row" >
	<div class="col-md-8 col-md-offset-2">
		<div class="embed-responsive embed-responsive-16by9">
			<iframe class="embed-responsive-item" src="http://www.youtube.com/embed/wxKSshd_CE0?rel=0&amp;controls=1&amp;showinfo=1" frameborder="0" allowfullscreen></iframe>	
		</div>
	</div>
</div>

<p>
	I want both devices to be able to request a time offset or provide one, so I run a server thread that listens on a predefined port for incoming udp packets, 
</p>

<pre class="prettyprint">
	public class UdpServerThread extends Thread {

		DatagramSocket socket;

		@Override
		public void run() {
			try {
				socket = new DatagramSocket(SERVERPORT);
				while (true) {
					byte[] buf = new byte[24];
					DatagramPacket packet = new DatagramPacket(buf, buf.length);
					socket.receive(packet);
					long serverreceive = System.currentTimeMillis();

					InetAddress clientAddress = packet.getAddress();
					int port = packet.getPort();

					long serversend = System.currentTimeMillis();
					byte[] sendbuf = ByteBuffer.allocate(24)
							.putLong(serverreceive).putLong(serversend)
							.putLong(accuratetime).array();
					packet = new DatagramPacket(sendbuf, sendbuf.length,
							clientAddress, port);
					Log.d("server", "playtime:" + accuratetime + " clock:"
							+ System.currentTimeMillis());
					sendUI("server playtime:" + accuratetime + " clock:"
							+ System.currentTimeMillis());
					socket.send(packet);
				}

			} catch (Exception e) {
				e.printStackTrace();
				sendUI("Server: Error!");
			}
		}
	}
</pre>